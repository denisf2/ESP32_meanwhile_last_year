<!DOCTYPE HTML>
<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0 maximum-scale=2.5, user-scalable=1">
    <title>Temperature Forecast Linechart demo</title>

    <style>
        :root {
            --primary-color: #1e88e5;
            --error-color: #d32f2f;
            --success-color: #388e3c;
        }

        body {
            background-color: powderblue;
            font-family: Arial, Helvetica, sans-serif;
        }

        .chart-container {
            /* width: 600px; */
            /* height: 400px; */
            width: 100%;
            min-height: 400px;
        }

        @media (max-width: 768px) {
            .chart-container {
                min-height: 300px;
            }
        }

        /* Style the tab */
        .tab {
            overflow: hidden;
            border: 1px solid #ccc;
            background-color: #f1f1f1;
        }

        /* Style the buttons inside the tab */
        .tab button {
            background-color: inherit;
            float: left;
            border: none;
            outline: none;
            cursor: pointer;
            padding: 14px 16px;
            transition: 0.3s;
            font-size: 17px;
        }

        /* Change background color of buttons on hover */
        .tab button:hover {
            background-color: #ddd;
        }

        /* Create an active/current tablink class */
        .tab button.active {
            background-color: #ccc;
        }

        /* Style the tab content */
        .tab-content {
            display: none;
            padding: 6px 12px;
            border: 1px solid #ccc;
            border-top: none;
        }

        .button_sys {
            margin-block-start: 5px;
            margin-block-end: 5px;
            background-color: DodgerBlue;
            border: none;
            color: white;
            padding: 12px 16px;
            font-size: 16px;
            cursor: pointer;
        }

        /* [ ]TODO: change to class */
        .marg-top {
            margin-top: 2px;
        }

        .chart-width{
            max-width: 600px;
        }

        .settings-width{
            max-width: 400px;
        }

        .form-settings {
            margin: 50px auto;
            padding: 20px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border: 2px solid #007bff;
        }

        .form-settings .form-group {
            margin-bottom: 20px;
        }

        .form-settings .form-input-group {
            margin-bottom: 10px;
        }

        .form-settings label {
            display: block;
            margin-bottom: 5px;
            color: #333;
        }

        .form-settings input[type="text"],
        .form-settings input[type="password"],
        .form-settings button {
            width: 94%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            transition: border-color 0.3s ease;
        }

        .form-settings input[type="text"]:focus,
        .form-settings input[type="password"]:focus {
            border-color: dodgerblue;
            outline: none;
        }

        .form-settings button {
            background-color: dodgerblue;
            width: 100%;
            color: #fff;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .form-settings button:hover {
            background-color: #007bff;
        }

        .survey-table td {
            font-size: 16px;
        }

        .survey-table td.td-right {
            padding: 10px;
            text-align: right;
        }

        .survey-table td.td-left {
            padding: 10px;
            text-align: left;
        }

        .hideable {
            display: default;
        }

        .hideable.hidden {
            display: none;
        }

        #map {
            width: 100%;
            height: 400px;
        }

        #coordinates {
            /* position: absolute; */
            bottom: 10px;
            left: 10px;
            background: rgba(255, 255, 255, 0.8);
            padding: 5px 10px;
            border-radius: 3px;
            font-family: Arial, sans-serif;
            font-size: 12px;
            z-index: 1000;
        }

        #controls {
            margin: 10px 0;
        }

        #mapModal {
            min-width: 400px;
            min-height: 300px;
        }

        .marker {
            background-image: url('https://docs.maptiler.com/openlayers/default-marker/marker-icon.png');
            background-size: cover;
            width: 25px;
            height: 41px;
            cursor: pointer;
        }

        /* Alert styles */
        .alert {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 1rem;
            color: white;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            transition: opacity 0.5s;
            /* opacity: 0; */
        }

        .alert-success {
            background-color: var(--success-color);
        }

        .alert-error {
            background-color: var(--error-color);
        }

        .alert-info {
            background-color: var(--primary-color);
        }
        /* developer styles */
        /* .info-dev {
            display: none;
        } */

        .dev-todo {
            display: none;
        }

    </style>
</head>

<body>
    <!-- Navigation -->
    <!-- <h2>Tabbed menu</h2> -->
    <!-- <p>Click on the buttons inside the tabbed menu:</p> -->
    <nav class="tab">
        <button id="tabChart" class="tab-head-button">
            <i class="fa fa-bar-chart"></i> Chart
        </button>
        <button id="tabSettings" class="tab-head-button">
            <i class="fa fa-cogs"></i> Settings
        </button>
        <button id="tabSystem" class="tab-head-button">
            <i class="fa fa-server"></i> System
        </button>
    </nav>

    <!-- Chart Tab -->
    <div id="panelChart" class="tab-content">
        <p class="dev-todo">Here should be some description.</p>
        <form class="form-settings chart-width"
              action="/"
              method="post"
              accept-charset="utf-8">

            <!-- [ ]TODO: scale for small screen -->
            <div id="chart-div" class="chart-container"></div>
            <!-- [ ]TODO: remove button -->
            <button class="button_sys"
                    type="submit"
                    id="updateChartButton">
                    <i class="fa fa-refresh"></i> Update Chart
            </button>
        </form>
    </div>

    <!-- Settings Tab -->
    <div id="panelSettings" class="tab-content">
        <p class="dev-todo">Here should be some description.</p>
        <form class="form-settings settings-width"
              id="settingsForm"
              accept-charset="utf-8">

            <div class="form-group">
                <label for="wifiSsid">WiFi SSID:</label>
                <input class="inputbox"
                        type="text"
                        id="wifiSsid"
                        name="wifiSsid"
                        title="WiFi SSID">
                <button type="button"
                        class="marg-top"
                        id="toggle-button">
                    <i class="fa fa-wifi"></i> Scan Networks
                </button>

                <table class="survey-table hideable hidden" id="table-content"></table>
            </div>

            <div class="form-group">
                <label for="wifiPassword">WiFi Password:</label>
                <input class="inputbox"
                        type="password"
                        id="wifiPassword"
                        name="wifiPassword"
                        title="WiFi Password">
            </div>

            <div class="form-group">
                <div class="form-input-group">
                    <label for="longitude">Longitude:</label>
                    <input class="inputbox"
                            type="text"
                            id="longitude"
                            name="longitude"
                            title="Longitude">
                </div>

                <div class="_form-input-group">
                    <label for="latitude">Latitude:</label>
                    <input class="inputbox"
                            type="text"
                            id="latitude"
                            name="latitude"
                            title="Latitude">
                </div>
                <button class="marg-top"
                        id="openMap"
                        type="button">
                    <i class="fa fa-map-marker"></i> Select on Map
                </button>
            </div>

            <div class="form-group">
                <!-- <a for="openWeatherKey" href="https://openweathermap.org/">OpenWeatherMap Key</a> -->
                <label class="form-label" for="openWeatherKey">
                    <i class="fa fa-key"></i> OpenWeatherMap API Key
                    <a href="https://openweathermap.org/" target="_blank">(Get Key)</a>
                </label>
                <input class="inputbox"
                        type="text"
                        id="openWeatherKey"
                        name="openWeatherKey"
                        title="OpenWeather API Key">
                <button class="marg-top"
                        id="openWeatherKeyCheck"
                        type="button">
                    <i class="fa fa-check"></i> Validate Key
                </button>
            </div>

            <div class="form-group">
                <!-- <a for="ip2geoKey" href="https://ipgeolocation.io/">IpGeolocation Key</a> -->
                <label class="form-label" for="ip2geoKey">
                    <i class="fa fa-key"></i> IpGeolocation API Key
                    <a href="https://ipgeolocation.io/" target="_blank">(Get Key)</a>
                </label>
                <input class="inputbox"
                        type="text"
                        id="ip2geoKey"
                        name="ip2geoKey"
                        title="IpGeolocation API Key">
                <button class="marg-top"
                        id="ip2geoKeyCheck"
                        type="button">
                    <i class="fa fa-check"></i> Validate Key
                </button>
            </div>

            <button class="button_sys"
                    type="submit"
                    id="submitSettingsButton">
                <i class="fa fa-save"></i> Save Settings
            </button>
        </form>
    </div>

    <!-- System Tab -->
    <div id="panelSystem" class="tab-content">
        <p class="dev-todo">Here should be some description.</p>
        <form class="form-settings settings-width">
            <button class="button_sys" id="setDefaultButton">
                <i class="fa fa-undo"></i> Reset to Defaults
            </button>
            <button class="button_sys" id="resetButton">
                <i class="fa fa-power-off"></i> Restart System
            </button>
        </form>
    </div>

    <!-- Map Modal -->
    <dialog id="mapModal" class="modal">
        <div id="controls">
            <span id="coordinates">Click the map to select a location</span>
        </div>
        <div id="map"></div>
        <div>
            <button id="cancelMap">Cancel</button>
            <button id="saveMap">Save Location</button>
        </div>
    </dialog>

    <!-- JavaScript -->
    <script type='text/javascript'>
        // ==============================================
        // Utility Functions
        // ==============================================
        // String format helper
        // https://stackoverflow.com/questions/1038746/equivalent-of-string-format-in-jquery/2648463#2648463
        String.prototype.format = String.prototype.f = function() {
            let s = this,
                i = arguments.length;

            while (i--) {
                s = s.replace(new RegExp('\\{' + i + '\\}', 'gm'), arguments[i]);
            }
            return s;
        };

        function debounce(func, wait) {
            let timeout;
            return function () {
                const context = this;
                const args = arguments;

                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), wait);
            };
        }

        function showSuccess(message) {
            showAlert(message, 'success');
        }

        function showError(message) {
            showAlert(message, 'error');
        }

        function showInfo(message) {
            showAlert(message, 'info');
        }

        function showAlert(message, aType) {
            const alert = document.createElement('div');
            alert.className = `alert alert-${aType}`;
            alert.textContent = message;
            document.body.appendChild(alert);

            setTimeout(() => {
                alert.style.opacity = '0';
                setTimeout(() => alert.remove(), 500);
            }, 3000);
        }

        // ==============================================
        // DOM Manipulation Functions
        // ==============================================

        function ShowTab(aTabId) {
            // Hide all tabs
            document.querySelectorAll(".tab-content")
                .forEach(elm => elm.style.display = "none");

            // Deactivate all buttons
            document.querySelectorAll(".tab-head-button")
                .forEach(button => button.classList.remove('active'));

            // Show selected tab
            document.getElementById(aTabId).style.display = "block";

            // Activate clicked button
            document.getElementById(aTabId.replace('panel', 'tab')).classList.add('active');
        }

        function onClickToggle() {
            document.querySelectorAll('.hideable')
                .forEach(h => h.classList.toggle('hidden'));
        }

        function UpdateKeyValidationStatus(aButtonId, aIsValid) {
            const button = document.getElementById(aButtonId);

            if (!button)
                return;

            const icon = button.querySelector('i') || document.createElement('i');
            icon.className = `fa ${"true" == aIsValid ? 'fa-check-circle' : 'fa-times-circle'}`;

            if (!button.querySelector('i')) {
                button.insertBefore(icon, button.firstChild);
            }
        }

        function createAPTable(aNode) {
            const str = `
                        ${CreateTableHeader()}
                        ${aNode.map(ap => CreateTableRaw(ap)).join('')}
                        `;

            document.getElementById('table-content').innerHTML = str;

            document.querySelectorAll('.ssid-button')
                .forEach(aButton => aButton.addEventListener('click'
                                            , (aEvent) => {
                                                let input = document.getElementById("wifiSsid");
                                                input.value = aEvent.target.textContent;

                                                onClickToggle();
                                            }
                                        )
                );
        }

        function CreateTableHeader() {
            return '<th>{0}</th><th>{1}</th><th>{2}</th><th>{3}</th>'.format('SSID', 'RSSI', 'Channel', 'Encryption');
        }

        function CreateTableRaw(aJsonNode) {
            const template = '<tr>\n'
                        +    '<td><button class="ssid-button"\n'
                        +                'type="button">\n'
                        +            '{0}\n'
                        +        '</button>\n'
                        +    '</td>\n'
                        +    '<td class="td-right">{1}</td>\n'
                        +    '<td class="td-right">{2}</td>\n'
                        +    '<td class="td-left">{3}</td>\n'
                        +  '</tr>\n';

            return template.format(aJsonNode["ssid"]
                                    , aJsonNode["rssi"]
                                    , aJsonNode["channel"]
                                    , aJsonNode["encryption"]
                                );
        }

        function populateForm(aData) {
            document.getElementById("wifiSsid").value = aData['WifiSsid'] || '';
            document.getElementById("wifiPassword").value = aData['WiFiPassword'] || '';
            document.getElementById("longitude").value = aData['Longitude'] || '';
            document.getElementById("latitude").value = aData['Latitude'] || '';
            document.getElementById("ip2geoKey").value = aData['IpGeolocKey'] || '';
            document.getElementById("openWeatherKey").value = aData['OpenWeatherKey'] || '';
        }

        // ==============================================
        // Chart Functions
        // ==============================================

        function generateTestValues() {
            // [ ]TODO: remove
            const testValues = [['Date', 'Tmin', 'Tmax', 'T']];

            for (let i = 0; i < 20; ++i)
                testValues.push([i, Math.sin(i), Math.cos(i), Math.log10(i)]);

            return testValues;
        }

        function generateValues(aJson) {
            // if ('string' != typeof aJson)
            //     return;

            console.debug('generateValues: incoming json %s', (0 == aJson.length) ? '[empty string]' : aJson);

            if(0 == aJson.length)
            {
                return generateTestValues();
            }

            const values = [['Date', 'Tmin', 'Tmax', 'T']];

            // example
            // {"message" : "ChartDataResponse",
            // "current":[14.3,12.2,15.1],
            // "daily":{
            //     "time": ["2024-04-08","2024-04-09","2024-04-10","2024-04-11","2024-04-12","2024-04-13","2024-04-14"],
            //     "temperature_2m_max":[16.4,18.4,19.2,18.3,14.3,12.3,12.6],
            //     "temperature_2m_min":[7.0,8.2,9.8,7.8,6.3,2.9,4.0]
            // }}

            const daily = aJson["daily"];
            const time = daily["time"];
            const tempMin = daily["temperature_2m_min"];
            const tempMax = daily["temperature_2m_max"];
            const current = aJson["current"];

            for (let i = 0; i < time.length; ++i)
                values.push([time[i], tempMin[i], tempMax[i], current[i]]);

            return values;
        }

        function getChartOptions() {
            const isMobile = window.innerWidth < 768;

            return {
                title: 'Local Temperature Log',
                legend: { position: isMobile ? 'bottom' : 'top' },
                chartArea: {
                    width: isMobile ? '80%' : '90%',
                    height: isMobile ? '65%' : '75%'
                },
                fontSize: isMobile ? 10 : 12,
                backgroundColor: 'transparent',
                vAxis: { title: 'Temperature, \u{2103}' },
                hAxis: { title: 'Date' },
                seriesType: 'line',
                series: { 2: { type: 'line' } }
            };
        }

        function getChartData() {
            return google.visualization.arrayToDataTable(chartValues);
        }

        function drawChart() {
            // let chartValues = generateTestValues();

            var data = getChartData();

            // Get dynamic options based on screen size
            var options = getChartOptions();

            // Instantiate and draw our chart
            const chart = new google.visualization.ComboChart($chartElement);
            chart.draw(data, options);

            // Store reference to current chart
            currentChart = chart;
            currentChart.getData = getChartData;
            currentChart.getOptions = getChartOptions;

            // Add event listener for window resize
            window.addEventListener('resize', update);

            // Setup ResizeObserver for container changes
            setupResizeObserver();
        }

        // Handle window resize event
        function update() {
            if (currentChart) {
                const data = currentChart.getData();
                const options = currentChart.getOptions();
                currentChart.draw(data, options);
            }
        }

        const $chartElement = document.getElementById('chart-div');

        function setupResizeObserver() {
            if (typeof ResizeObserver !== 'undefined') {
                const resizeObserver = new ResizeObserver(debounce(update, 150));
                resizeObserver.observe($chartElement);
            }
        }

        function onLoadGoogleCharts() {
            google.charts.load('current', { 'packages': ['corechart'] });
            google.charts.setOnLoadCallback(drawChart);
        }

        // ==============================================
        // Map Functions
        // ==============================================
        const $mapModal = document.querySelector('#mapModal');

        let map;
        // Variables for location picking
        let tmpCoordinate;

        function InitMapModal() {
            if (!map) {
                // Create map with OSM layer
                map = new ol.Map({
                    target: 'map',
                    layers: [
                        new ol.layer.Tile({
                            source: new ol.source.OSM()
                        })
                    ],
                    view: new ol.View({
                        center: ol.proj.fromLonLat([0, 0]), // Center at [0,0]
                        zoom: 2
                    })
                });

                const markerLayer = new ol.layer.Vector({
                    source: new ol.source.Vector()
                });

                map.addLayer(markerLayer);

                // Handle map clicks
                map.on('click', (event) => onMapClick(event, markerLayer));
            }

            // Center on current location if available
            const lon = parseFloat(document.getElementById('longitude').value);
            const lat = parseFloat(document.getElementById('latitude').value);

            if (!isNaN(lon) && !isNaN(lat)) {
                map.getView().setCenter(ol.proj.fromLonLat([lon, lat]));
                map.getView().setZoom(10);
            }
        }

        function onMapClick(aEvent, aMarkerLayer) {
            // Clear previous marker
            aMarkerLayer.getSource().clear();

            // Create new marker
            const coordinate = aEvent.coordinate;
            const marker = new ol.Feature({
                geometry: new ol.geom.Point(coordinate)
            });

            aMarkerLayer.getSource().addFeature(marker);

            // Convert to lon/lat
            const lonLat = ol.proj.toLonLat(coordinate);
            tmpCoordinate = lonLat;

            // Display coordinates
            document.getElementById('coordinates').textContent =
                `Selected location: ${lonLat[1].toFixed(6)}°N, ${lonLat[0].toFixed(6)}°E`;
        }

        function SaveMapLocation() {
            if (!tmpCoordinate) {
                alert('Please select a location on the map first');
                return;
            }

            document.getElementById('latitude').value = tmpCoordinate[1].toFixed(6);
            document.getElementById('longitude').value = tmpCoordinate[0].toFixed(6);

            $mapModal.close('exit');
        }

        function OpenMapModal() {
            $mapModal.showModal();
            setTimeout(InitMapModal, 100);
        }

        function closeMapModal() {
            $mapModal.close('exit');
        }

        // ==============================================
        // WebSocket Functions
        // ==============================================
        let gateway = `ws://${window.location.hostname}/ws`;
        let websocket;
        let currentChart;
        let chartValues = generateValues('');

        function initWebSocket() {
            console.log('Trying to open WebSocket connection...');
            websocket = new WebSocket(gateway);
            websocket.onopen = () => console.log('Connection opened');
            websocket.onclose = () => {
                                    console.log('Connection closed');
                                    setTimeout(initWebSocket, 2000);
                                };
            websocket.onmessage = HandleWebSocketMessage;
            websocket.onerror = (aError) => console.log('WebSocket error:', aError);
        }

        function HandleWebSocketMessage(aEvent) {
            try {
                const json = JSON.parse(aEvent.data);
                switch (json['message']) {
                    case "ip2geoTest":
                    {
                        UpdateKeyValidationStatus("ip2geoKeyCheck", json['valid']);

                        let keyStatus = ("true" == json['valid']) ? "Validated" : "Not valid";
                        console.log('IpGeoloc Key status: %s', keyStatus)
                        break;
                    }
                    case "openWeatherTest":
                    {
                        UpdateKeyValidationStatus("openWeatherKeyCheck", json['valid']);

                        let keyStatus = ("true" == json['valid']) ? "Validated" : "Not valid";
                        console.log('Openweather Key status: %s', keyStatus)
                        break;
                    }
                    case "FormFillStoredData":
                    {
                        populateForm(json);

                        console.log('Form Fill message');
                        break;
                    }
                    case "wifiAps":
                    {
                        console.log('Available WiFi access points');

                        createAPTable(json["APs"]);
                        break;
                    }
                    case "ChartDataResponse":
                    {
                        // [ ]TODO: update chart
                        chartValues = generateValues(json);

                        console.debug('ChartDataResponse');
                        break;
                    }
                    default:
                        console.log('Recieved message:', json);
                }
            } catch (aError) {
                console.error('Error processing message:', aError);
            }
        }

        function sendWebSocketMessage(aData) {
            if (!websocket || WebSocket.OPEN !== websocket.readyState) {
                console.warn('WebSocket is not connected');
                return false;
            }

            try {
                websocket.send(JSON.stringify(aData));
                return true;
            } catch (aError) {
                console.error('Error sending WebSocket message:', aError);
                return false;
            }
        }

        // ==============================================
        // Form Handling Functions
        // ==============================================
        function validateApiKey(aCtrlID, aMessageType) {
            const key = document.getElementById(aCtrlID).value.trim();
            if (!key) {
                alert('Please enter an API key first');
                return;
            }

            sendWebSocketMessage({
                message : aMessageType
                , apikey: key
            });
        }

        function validateInputData() {
            // validate data from form controls and post it to the server
            let validateKeyChars = (apikey, message) => {
                const regHexOnlyLen32 = /^[0-9a-f]{32}$/i;

                // empty string is valid to submit form
                if("" === apikey || regHexOnlyLen32.test(aApiKey)) {
                    return true;
                }

                console.warn(message);
                alert(message);

                return false;
            }

            const openWeatherKey = document.getElementById("openWeatherKey").value;
            const ip2geoKey = document.getElementById("ip2geoKey").value;

            return validateKeyChars(openWeatherKey, "Invalid Openweather API key")
                && validateKeyChars(ip2geoKey, "Invalid IpGeolocation API key");
        }

        async function SubmitSettingsForm(aEvent) {
            aEvent.preventDefault();

            try {
                const form = aEvent.target;
                let url = window.location.origin + "/update";
                let urlEncodedData = new URLSearchParams(new FormData(form)).toString();
                let request = {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/x-www-form-urlencoded',
                                },
                                body: urlEncodedData
                            };
                let response = await fetch(url, request);

                if (!response.ok) {
                    throw new Error(`Server responded with status: ${response.status}`);
                }

                showSuccess('Settings saved successfully');

            } catch (aError) {
                console.error(`Error: ${aError}`);
                showError('Failed to save settings');
            }
        }

        function RequestFormData() {
            sendWebSocketMessage({message : 'FormFill'});
        }

        function AcquireWiFiAPs() {
            sendWebSocketMessage({message : 'AcquireWiFiAPs'});
        }

        function RequestChartData() {
            sendWebSocketMessage({message: 'ChartDataRequest'});
        }

        // ==============================================
        // Resource managing functions
        // ==============================================
        function CreateStyleElement(aHref) {
            const link = document.createElement('link');
            link.href = aHref;
            link.rel = 'stylesheet';
            link.type = 'text/css';
            link.async = true;

            return link;
        }

        function CreateScriptElement (aSrc) {
            const script = document.createElement('script');
            script.src = aSrc;
            script.async = true;

            return script;
        }

        async function checkResourceAvailability(aUrl) {
            try {
                const response = await fetch(aUrl, {
                    method: 'HEAD'
                    , mode: 'no-cors'
                });
                return response.ok || response.type === 'opaque';
            } catch (error) {
                console.warn(`Availability check failed for ${aUrl}:`, error);
                return false;
            }
        }

        async function LoadResource(aResource) {
            const {url, type, onLoad, onError} = aResource;

            const isAvailable = await checkResourceAvailability(url);
            if (!isAvailable) {
                console.warn(`Resource unavailable: ${url}`);
                throw new Error(`Resource ${url} not available`);
            }

            const element = ('css' === type)
                ? CreateStyleElement(url)
                : CreateScriptElement(url);

            return new Promise((aResolve, aReject) => {
                    element.onload = () => {
                        onLoad?.();
                        aResolve();
                    };

                    element.onerror = () => {
                        onError?.();
                        aReject(new Error(`Failed to load ${url}`));
                    };

                    (('css' === type) ? document.head : document.body).appendChild(element);
                });
        }

        // Loading third party lib/
        const resources = [
            {
                url : 'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css'
                , type : 'css'
                , onLoad : () => console.log('Font awesome loaded')
                , onError : () => console.error('Font awesome failed to load')
            },
            {
                url : 'https://www.gstatic.com/charts/loader.js'
                , type : 'js'
                , onLoad : () => {
                                console.log('Google charts script loaded');
                                onLoadGoogleCharts();
                                RequestChartData();
                            }
                , onError : () => console.error('Failed to load Google charts script')
            },
            {
                url : 'https://cdn.jsdelivr.net/npm/ol@v8.2.0/dist/ol.js'
                , type : 'js'
                , onLoad : () => console.log('OpenLayers script loaded')
                , onError : () => console.error('Failed to load OpenLayers script')
            },
            {
                url : 'https://cdn.jsdelivr.net/npm/ol/ol.css'
                , type : 'css'
                , onLoad : () => console.log('OpenLayers CSS loaded')
                , onError : () => console.error('OpenLayers failed to load')
            }
        ];

        function LoadAllResources() {
            return Promise.all(resources.map(
                (aRes) => {
                    LoadResource(aRes)
                    .catch((aError) => {
                        console.error(`Error loading ${aRes.url}:`, aError);
                        return null; // Continue even if some fail
                    });
                }));
        }

        // ==============================================
        // Initialization
        // ==============================================
        function SetupUI() {
            // document.getElementById('toggle')
            //     ?.addEventListener('click', (e) => {
            //         document.querySelectorAll('.hideable')
            //                 .forEach(h => h.classList.toggle('hidden'));
            //     });

            document.getElementById('resetButton')
                            .addEventListener('click', () => {
                                    if (confirm('Are you sure you want to restart the system?')) {
                                        sendWebSocketMessage({ message: 'RestartSystem' });
                                    }
                                });

            document.getElementById('setDefaultButton')
                            .addEventListener('click', () => {
                                if (confirm('Reset all settings to default values?')) {
                                    sendWebSocketMessage({ message: 'ResetToDefaults' });
                                }
                            });

            document.querySelectorAll('.tab-head-button').forEach(
                (button) => {
                    button.addEventListener('click'
                        , (event) => {
                                const tabId = event.currentTarget.id.replace('tab', 'panel');
                                ShowTab(tabId);

                                if('panelSettings' === tabId) {
                                    RequestFormData();
                                    AcquireWiFiAPs();
                                }
                            });
                });

            document.querySelector('#toggle-button')
                    ?.addEventListener('click', onClickToggle);

            document.querySelector('#updateChartButton')
                    ?.addEventListener('click', update);

            document.querySelector('#openWeatherKeyCheck')
                    ?.addEventListener('click', (e) => {
                                                    return validateApiKey('openWeatherKey', 'openWeatherTest');
                                                });

            document.querySelector('#ip2geoKeyCheck')
                    ?.addEventListener('click', (e) => {
                                                    return validateApiKey('ip2geoKey', 'ip2geoTest');
                                                });

            document.querySelector('#submitSettingsButton')
                    ?.addEventListener('click', (e) => {
                                                    return validateInputData();
                                                });

            document.getElementById("settingsForm")
                    ?.addEventListener('submit', SubmitSettingsForm);

            document.querySelector('#openMap')
                    ?.addEventListener('click', OpenMapModal);

            document.querySelector('#saveMap')
                    ?.addEventListener('click', SaveMapLocation);

            document.querySelector('#cancelMap')
                    ?.addEventListener('click', closeMapModal);

            // select first tab and tab content
            const firstTabButton = document.querySelector('nav > button:first-child');
            ShowTab(firstTabButton.id.replace('tab', 'panel'));
        }

        function Init() {
            LoadAllResources()
            .then(() => SetupUI())
            .then(() => initWebSocket())
            .then(() => {
                setTimeout(RequestFormData, 1000);
                setTimeout(RequestChartData, 1000);
                setTimeout(AcquireWiFiAPs, 1000);
            })
            .catch((aError) => {
                console.error('Initialization error:', aError);
                showError('Failed to initialize application');
            });
        }

        // Start loading when DOM is ready
        if ('loading' === document.readyState) {
            document.addEventListener('DOMContentLoaded', Init);
        } else {
            Init();
        }
    </script>
</body>

</html>