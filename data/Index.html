<!DOCTYPE HTML>
<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0 maximum-scale=2.5, user-scalable=1">
    <title>Temperature Forecast Linechart demo</title>

    <style>
        body {
            background-color: powderblue;
            font-family: Arial, Helvetica, sans-serif;
        }

        .chart-container {
            /* width: 600px; */
            /* height: 400px; */
            width: 100%;
            min-height: 400px;
        }

        @media (max-width: 768px) {
            .chart-container {
                min-height: 300px;
            }
        }

        /* Style the tab */
        .tab {
            overflow: hidden;
            border: 1px solid #ccc;
            background-color: #f1f1f1;
        }

        /* Style the buttons inside the tab */
        .tab button {
            background-color: inherit;
            float: left;
            border: none;
            outline: none;
            cursor: pointer;
            padding: 14px 16px;
            transition: 0.3s;
            font-size: 17px;
        }

        /* Change background color of buttons on hover */
        .tab button:hover {
            background-color: #ddd;
        }

        /* Create an active/current tablink class */
        .tab button.active {
            background-color: #ccc;
        }

        /* Style the tab content */
        .tab-content {
            display: none;
            padding: 6px 12px;
            border: 1px solid #ccc;
            border-top: none;
        }

        .button_sys {
            margin-block-start: 5px;
            margin-block-end: 5px;
            background-color: DodgerBlue;
            border: none;
            color: white;
            padding: 12px 16px;
            font-size: 16px;
            cursor: pointer;
        }

        /* [ ]TODO: change to class */
        .testbutton-marg-top {
            margin-top: 2px;
        }

        .chart-width{
            max-width: 600px;
        }

        .settings-width{
            max-width: 400px;
        }

        .form-settings {
            margin: 50px auto;
            padding: 20px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border: 2px solid #007bff;
        }

        .form-settings .form-group {
            margin-bottom: 20px;
        }

        .form-settings label {
            display: block;
            margin-bottom: 5px;
            color: #333;
        }

        .form-settings input[type="text"],
        .form-settings input[type="password"],
        .form-settings button {
            width: 94%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            transition: border-color 0.3s ease;
        }

        .form-settings input[type="text"]:focus,
        .form-settings input[type="password"]:focus {
            border-color: dodgerblue;
            outline: none;
        }

        .form-settings button {
            background-color: dodgerblue;
            width: 100%;
            color: #fff;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .form-settings button:hover {
            background-color: #007bff;
        }

        .survey-table td {
            font-size: 16px;
        }

        .survey-table td.td-right {
            padding: 10px;
            text-align: right;
        }

        .survey-table td.td-left {
            padding: 10px;
            text-align: left;
        }

        .hideable {
            display: default;
        }

        .hideable.hidden {
            display: none;
        }

        /* developer styles */
        .info-dev {
            display: none;
        }

        .dev-todo {
            display: none;
        }

    </style>
</head>

<body>
    <!-- <h2>Tabs</h2> -->
    <!-- <p>Click on the buttons inside the tabbed menu:</p> -->

    <div class="tab">
        <button class="tablinks active" onclick="openTab(event, 'Chart')"><i class="fa fa-bar-chart"></i> Chart</button>
        <button class="tablinks" onclick="openTabSettings(event, 'Settings')"><i class="fa fa-file-text-o"></i> Settings</button>
        <button class="tablinks" onclick="openTab(event, 'System')"><i class="fa fa-cogs"></i> System</button>
    </div>

    <div id="Chart" class="tab-content" style="display: block;">
        <!-- <h3>Chart</h3> -->
        <p class="dev-todo">Here should be some description.</p>
        <!-- <h3 style='color:brown'>Room Temperature</h1> -->

        <!-- <form action="/" method="post">-->
        <form class="form-settings chart-width"
              action="/"
              method="post"
              accept-charset="utf-8">
            <!-- [ ]TODO: scale for small screen -->
            <div id='chart-div' class="chart-container">
            </div>
            <!-- [ ]TODO: remove button -->
            <button class="button_sys"
                    type="submit"
                    id="updateChartButton"
                    onclick='update()'>
                CLICK FOR UPDATE
            </button>
        </form>
    </div>

    <div id="Settings" class="tab-content">
        <!-- <h3>Settings</h3> -->
        <p class="dev-todo">Here should be some description.</p>
        <form class="form-settings settings-width"
              id="SettingsForm"
              action="/update"
              accept-charset="utf-8">
            <div class="form-group">
                <label for="wifiSsid">WiFi SSID:</label>
                <input class="inputbox"
                        type="text"
                        id="wifiSsid"
                        name="wifiSsid"
                        title="WiFi SSID">
                <button type="button"
                        class="testbutton-marg-top"
                        id="toggle-button"
                        onclick="onClickToggle()">
                    Survey
                </button>
                <table class="survey-table hideable hidden" id="table-content"></table>
                <!-- <span class="info-dev" id="info-wifiSsid">status</span> -->
            </div>

            <div class="form-group">
                <label for="wifiPassword">WiFi Password:</label>
                <input class="inputbox" type="password" id="wifiPassword" name="wifiPassword" title="WiFi Password">
                <!-- <span class="info-dev" id="info-wifiPass">status</span> -->
            </div>

            <div class="form-group">
                <label for="longitude">Longitude:</label>
                <input class="inputbox" type="text" id="longitude" name="longitude" title="Longitude">
                <!-- <span class="info-dev" id="info-longitude">status</span> -->
            </div>

            <div class="form-group">
                <label for="latitude">Latitude:</label>
                <input class="inputbox" type="text" id="latitude" name="latitude" title="Latitude">
                <!-- <span class="info-dev" id="info-latitude">status</span> -->
            </div>
            <div class="form-group">
                <a for="openWeatherKey" href="https://openweathermap.org/">OpenWeatherMap Key</a>
                <input class="inputbox"
                        type="text"
                        id="openWeatherKey"
                        name="openWeatherKey"
                        title="OpenWeather API Key">
                <button class="testbutton-marg-top"
                        id="openWeatherKeyCheck"
                        type="button"
                        onclick="return OnTestButtonClick(openWeatherKey)">
                    Check Key
                </button>
                <!-- <span class="info-dev" id="info-opwKey">status</span> -->
            </div>

            <div class="form-group">
                <a for="ip2geoKey" href="https://ipgeolocation.io/">IpGeolocation Key</a>
                <input class="inputbox" type="text" id="ip2geoKey" name="ip2geoKey" title="IpGeolocation API Key">
                <button class="testbutton-marg-top"
                        id="ip2geoKeyCheck"
                        type="button"
                        onclick="return OnTestButtonClick(ip2geoKey)">
                    Check Key
                </button>
                <!-- <span class="info-dev" id="info-ip2geoKey">status</span> -->
            </div>

            <button class="button_sys"
                    type="submit"
                    id="settings-submit-button"
                    onclick='return submitSettings()'>
                Submit
            </button>
        </form>
    </div>

    <div id="System" class="tab-content">
        <p class="dev-todo">Here should be some description.</p>
        <form class="form-settings settings-width" id="SystemForm">
            <button class="button_sys"
                    type="submit"
                    id="buttonResetDefault"
                    formaction="/default">
                Reset to Default
            </button>
            <br>
            <button class="button_sys"
                    type="submit"
                    id="buttonRestart"
                    formaction="/restart">
                Restart
            </button>
        </form>
    </div>

    <script type='text/javascript'>

        // String format helper
        // https://stackoverflow.com/questions/1038746/equivalent-of-string-format-in-jquery/2648463#2648463
        String.prototype.format = String.prototype.f = function() {
            let s = this,
                i = arguments.length;

            while (i--) {
                s = s.replace(new RegExp('\\{' + i + '\\}', 'gm'), arguments[i]);
            }
            return s;
        };

        async function checkScriptAvailability(url) {
            try {
                const response = await fetch(url, { method: 'HEAD', mode: 'no-cors' });
                return response.ok || response.type === 'opaque';
            } catch {
                return false;
            }
        }

        let fontAwesomStyleUrl = 'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css';

        // try to get font awesom style
        checkScriptAvailability(fontAwesomStyleUrl)
            .then((available) => {
                if (available) {
                    const script = document.createElement('link');
                    script.href = fontAwesomStyleUrl;
                    script.rel = 'stylesheet';
                    script.type = 'text/css';
                    script.async = true;
                    script.onload = () => {
                        console.log('Font awesome loaded');
                    };
                    script.onerror = () => {
                        console.error('Font awesome failed to load');
                    };
                    document.head.appendChild(script);
                } else {
                    console.warn('Script unavailable, loading fallback');
                    // Load fallback script
                }
            });

            let googleChartssUrl = 'https://www.gstatic.com/charts/loader.js';

            // try to get google chart script
            checkScriptAvailability(googleChartssUrl)
                .then((available) => {
                    if (available) {
                        const script = document.createElement('script');
                        script.src = googleChartssUrl;
                        script.async = true;
                        script.onload = () => {
                            console.log('Google charts script loaded')
                            onLoadGoogleCharts();
                            RequstChartData();
                        };
                        script.onerror = () => {
                            console.error('Failed to load Google charts script')
                        };
                        document.body.appendChild(script);
                    } else {
                        console.warn('Script unavailable, loading fallback');
                        // Load fallback script
                    }
                });

        // document.getElementById('toggle')
        //     ?.addEventListener('click', (e) => {
        //         document.querySelectorAll('.hideable')
        //                 .forEach(h => h.classList.toggle('hidden'));
        //     });


        function onClickToggle() {
            document.querySelectorAll('.hideable')
                .forEach(h => h.classList.toggle('hidden'));
        }

        function onLoadGoogleCharts() {
            google.charts.load('current', { 'packages': ['corechart'] });
            google.charts.setOnLoadCallback(drawChart);
        }

        let gateway = `ws://${window.location.hostname}/ws`;
        let websocket;
        let currentChart;
        let chartValues = generateValues('');

        window.addEventListener('load', (aEvent) => {
                initWebSocket();
                setTimeout(RequestFormData, 1000);
                setTimeout(RequstChartData, 1000);
                setTimeout(AcquireWiFiAPs, 1000);
            });

        function initWebSocket() {
            console.log('Trying to open WebSocket connection...');
            websocket = new WebSocket(gateway);
            websocket.onopen = onOpen;
            websocket.onclose = onClose;
            websocket.onmessage = onMessage;
        }

        function onOpen(aEvent) {
            console.log('Connection opened');
        }

        function onClose(aEvent) {
            console.log('Connection closed');
            setTimeout(initWebSocket, 2000);
        }

        function onMessage(aEvent) {
            try {
                let json = JSON.parse(aEvent.data);
                switch (json['message'])
                {
                    case "ip2geoTest":
                    {
                        PasteRemoveCheckMark("ip2geoKeyCheck", json['valid']);

                        let keyStatus = ("true" == json['valid']) ? "Validated" : "Not valid";
                        console.log('IpGeoloc Key status: %s', keyStatus)
                        break;
                    }
                    case "openWeatherTest":
                    {
                        PasteRemoveCheckMark("openWeatherKeyCheck", json['valid']);

                        let keyStatus = ("true" == json['valid']) ? "Validated" : "Not valid";
                        console.log('Openweather Key status: %s', keyStatus)
                        break;
                    }
                    case "FormFillStoredData":
                    {
                        document.getElementById("wifiSsid").value = json['WifiSsid'];
                        document.getElementById("wifiPassword").value = json['WiFiPassword'];
                        document.getElementById("longitude").value = json['Longitude'];
                        document.getElementById("latitude").value = json['Latitude'];
                        document.getElementById("ip2geoKey").value = json['IpGeolocKey'];
                        document.getElementById("openWeatherKey").value = json['OpenWeatherKey'];

                        console.log('Form Fill message');
                        break;
                    }
                    case "wifiAps":
                    {
                        console.log('Available WiFi access points');

                        let str = CreateTableHeader();

                        let node = json["APs"];
                        for(let i = 0; i < node.length; ++i)
                            str += CreateTableRaw(node[i]);

                        document.getElementById('table-content').innerHTML = str;

                        break;
                    }
                    case "ChartDataResponse":
                    {
                        // [ ]TODO: update chart
                        chartValues = generateValues(json);
                        console.debug('ChartDataResponse');
                        break;
                    }
                    default:
                        console.log('JSON message: %s', aEvent.data);
                }

                switch (aEvent.data)
                {
                    case "beaf":
                        // [ ]TODO: remove test code
                        console.log('[dev] Get WebSocket data: %s', aEvent.data)
                        updateInfoDev(aEvent.data);
                        break;
                    default:
                        console.log('[dev] Unknown websocket argument: %s', aEvent.data)
                }
            }
            catch (aError)
            {
                console.log('onMessage Error: %s', aError);
            }
        }

        function CreateTableHeader() {
            return '<th>{0}</th><th>{1}</th><th>{2}</th><th>{3}</th>'.format('SSID', 'RSSI', 'Channel', 'Encryption');
        }

        function CreateTableRaw(aJsonNode) {
            let template = '<tr>\n'
                        +    '<td><button class="ssid-button"\n'
                        +                'type="button"\n'
                        +                'onclick="SsidButtonOnClick(\'{0}\')">\n'
                        +            '{0}\n'
                        +        '</button>\n'
                        +    '</td>\n'
                        +    '<td class="td-right">{1}</td>\n'
                        +    '<td class="td-right">{2}</td>\n'
                        +    '<td class="td-left">{3}</td>\n'
                        +  '</tr>\n';

            return template.format(aJsonNode["ssid"]
                                    , aJsonNode["rssi"]
                                    , aJsonNode["channel"]
                                    , aJsonNode["encryption"]
                                );
        }

        function PasteRemoveCheckMark(aButtonName, aState) {
            let checkMark = '\u{2713}';
            let obj = document.getElementById(aButtonName);
            if ("true" == aState)
            {
                if (!obj.textContent.endsWith(checkMark))
                    obj.textContent += " " + checkMark;
            }
            else
            {
                obj.textContent = obj.textContent.replace(" " + checkMark, "");
            }
        }

        function SsidButtonOnClick(aButtonName) {
            let input = document.getElementById("wifiSsid");
            input.value = aButtonName;

            onClickToggle();
        }

        function updateInfoDev(aInfo) {
            // [ ]TODO: remove test code
            let infoParag = document.getElementsByClassName("info-dev");
            for (let i = 0; i < infoParag.length; i++) {
                infoParag[i].innerText = aInfo;
            }
        }

        function CtrlToMessageID(aCtrlID) {
            switch (aCtrlID.id)
            {
                case "ip2geoKey":
                    return "ip2geoTest";
                case "openWeatherKey":
                    return "openWeatherTest";
                default:
                    console.log("Unknown control id: %s", aCtrlID.id);

                return "Unknown"
            }
        }

        function OnTestButtonClick(aCtrlID) {
            if('undefined' === typeof websocket || WebSocket.OPEN != websocket.readyState){
                console.warn('WebSocket has not opened yet');
                return false;
            }

            var obj = new Object();
            obj.message = CtrlToMessageID(aCtrlID);
            obj.apikey = aCtrlID.value;

            var jsonString = JSON.stringify(obj);
            websocket.send(jsonString);

            return true;
        }

        function RequestFormData() {
            if('undefined' === typeof websocket || WebSocket.OPEN != websocket.readyState){
                console.warn('WebSocket has not opened yet');
                return;
            }

            var obj = new Object();
            obj.message = "FormFill";

            var jsonString = JSON.stringify(obj);
            websocket.send(jsonString);
        }

        function AcquireWiFiAPs() {
            if('undefined' === typeof websocket || WebSocket.OPEN != websocket.readyState){
                console.warn('WebSocket has not opened yet');
                return;
            }

            var obj = new Object();
            obj.message = "AcquireWiFiAPs";

            var jsonString = JSON.stringify(obj);
            websocket.send(jsonString);
        }

        function RequstChartData() {
            if('undefined' === typeof websocket || WebSocket.OPEN != websocket.readyState){
                console.warn('WebSocket has not opened yet');
                return false;
            }

            var obj = new Object();
            // request chart data if available
            obj.message = 'ChartDataRequest';

            var jsonString = JSON.stringify(obj);
            websocket.send(jsonString);

            return true;
        }

        // SettingsForm.onsubmit = async (e) => {
        //     e.preventDefault();
        //     let host = window.location.host + "/update";
        //     let response = await fetch(host, {
        //                                 method: 'POST',
        //                                 body: new FormData(SettingsForm)
        //                             });
        //
        //     let result = await response.json();
        //
        //     // alert(result.message);
        //
        //     alert(true);
        // };

        function debounce(func, wait) {
            let timeout;
            return function () {
                const context = this;
                const args = arguments;

                clearTimeout(timeout);
                timeout = setTimeout(
                    () => {
                        func.apply(context, args);
                    }
                    , wait
                );
            };
        }

        function generateTestValues() {
            // [ ]TODO: remove
            let testValues = [['Date', 'Tmin', 'Tmax', 'T']];

            for (let i = 0; i < 20; ++i)
                testValues.push([i, Math.sin(i), Math.cos(i), Math.log10(i)]);

            return testValues;
        }

        function generateValues(aJson) {
            // if ('string' != typeof aJson)
            //     return;

            console.debug('generateValues: incoming json %s', (0 == aJson.length) ? '[empty string]' : aJson);

            if(0 == aJson.length)
            {
                return generateTestValues();
            }

            let values = [['Date', 'Tmin', 'Tmax', 'T']];

            // example
            // {"message" : "ChartDataResponse",
            // "current":[14.3,12.2,15.1],
            // "daily":{
            //     "time": ["2024-04-08","2024-04-09","2024-04-10","2024-04-11","2024-04-12","2024-04-13","2024-04-14"],
            //     "temperature_2m_max":[16.4,18.4,19.2,18.3,14.3,12.3,12.6],
            //     "temperature_2m_min":[7.0,8.2,9.8,7.8,6.3,2.9,4.0]
            // }}

            let daily = aJson["daily"];
            let time = daily["time"];
            let tempMin = daily["temperature_2m_min"];
            let tempMax = daily["temperature_2m_max"];
            let current = aJson["current"];

            for (let i = 0; i < time.length; ++i)
                values.push([time[i], tempMin[i], tempMax[i], current[i]]);

            return values;
        }

        function getChartOptions() {
            const isMobile = window.innerWidth < 768;

            return {
                title: 'Local Temperature Log',
                legend: { position: isMobile ? 'bottom' : 'top' },
                chartArea: {
                    width: isMobile ? '80%' : '90%',
                    height: isMobile ? '65%' : '75%'
                },
                fontSize : isMobile ? 10 : 12,
                backgroundColor: 'transparent'
            };
        }

        function getChartData() {
            return google.visualization.arrayToDataTable(chartValues);
        }

        function drawChart() {
            // let chartValues = generateTestValues();

            var data = getChartData();

            // Get dynamic options based on screen size
            var options = getChartOptions();

            // Instantiate and draw our chart
            const chart = new google.visualization.LineChart(document.getElementById('chart-div'));
            chart.draw(data, options);

            // Store reference to current chart
            currentChart = chart;
            currentChart.getData = getChartData;
            currentChart.getOptions = getChartOptions;

            // Add event listener for window resize
            window.addEventListener('resize', update);

            // Setup ResizeObserver for container changes
            setupResizeObserver();
        }

        // Handle window resize event
        function update() {
            if (currentChart) {
                const data = currentChart.getData();
                const options = currentChart.getOptions();
                currentChart.draw(data, options);
            }
        }

        function setupResizeObserver() {
            if (typeof ResizeObserver !== 'undefined') {
                const chartElement = document.getElementById('chart-div');
                const resizeObserver = new ResizeObserver(
                    debounce(
                        () => {
                            update();
                        }
                        , 150
                    )
                );
                resizeObserver.observe(chartElement);
            }
        }

        function openTabSettings(evt, tabLabel) {
            openTab(evt, tabLabel);
            RequestFormData();
            AcquireWiFiAPs();
        }

        function openTab(evt, tabLabel) {
            let tabcontent = document.getElementsByClassName("tab-content");
            for (let i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }

            let tablinks = document.getElementsByClassName("tablinks");
            for (let i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }

            document.getElementById(tabLabel).style.display = "block";
            evt.currentTarget.className += " active";
        }

        function submitSettings() {
            // validate data from form controls and post it to the server
            let validateKeyChars = (apikey, message) => {
                const regHexOnlyLen32 = /^[0-9a-f]{32}$/i;

                // empty string is valid to submit form
                if("" == apikey || regHexOnlyLen32.test(apikey)) {
                    return true;
                }

                console.warn(message);
                alert(message);

                return false;
            };

            const form = document.forms["SettingsForm"];

            return validateKeyChars(form["openWeatherKey"].value, "Invalid Openweather API key")
                && validateKeyChars(form["ip2geoKey"].value, "Invalid IpGeolocation API key");
        }
    </script>
</body>

</html>